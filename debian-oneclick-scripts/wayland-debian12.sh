#!/bin/bash

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸŒ ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Wayland Ğ½Ğ° Debian 12
# ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµÑ‚ Wayland Ğ² GDM + Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° NVIDIA
# Ğ—Ğ°Ğ¿ÑƒÑĞº: sudo bash setup-wayland.sh
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

set -euo pipefail

echo "ğŸš€ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Wayland Ğ½Ğ° Debian 12..."

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Debian 12
if ! grep -q "bookworm" /etc/os-release; then
    echo "â— Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¿Ñ€ĞµĞ´Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ Ğ´Ğ»Ñ Debian 12 (bookworm)"
    lsb_release -a 2>/dev/null || cat /etc/os-release
    exit 1
fi

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ñ‡ĞµÑ€ĞµĞ· sudo
if [ "$EUID" -ne 0 ]; then
    echo "â— Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ğ¹: sudo bash $0"
    exit 1
fi

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: GNOME ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½
if ! dpkg -l | grep -q "gnome-session\|gdm3" 2>/dev/null; then
    echo "ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° GNOME (ÑĞµÑÑĞ¸Ñ + Ğ´Ğ¸ÑĞ¿Ğ»ĞµĞ¹-Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€)..."
    apt update
    apt install -y gnome-session gdm3
fi

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: Wayland-ÑĞµÑÑĞ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°
if [ ! -f /usr/share/wayland-sessions/gnome.desktop ]; then
    echo "âŒ Wayland-ÑĞµÑÑĞ¸Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ, ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ»Ğ¸ Ğ¿Ğ°ĞºĞµÑ‚ 'gnome-session'"
    exit 1
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Wayland Ğ² GDM
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ”§ Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Wayland Ğ² GDM..."
GDM_CONF="/etc/gdm3/daemon.conf"

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ñ„Ğ°Ğ¹Ğ», ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
if [ ! -f "$GDM_CONF" ]; then
    echo "ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ $GDM_CONF..."
    touch "$GDM_CONF"
fi

# Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€ÑƒÑ ÑÑ‚Ñ€Ğ¾ĞºÑƒ WaylandEnable
sed -i '/^WaylandEnable/d' "$GDM_CONF" 2>/dev/null || true

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½ÑƒÑ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ
if grep -q "\[daemon\]" "$GDM_CONF"; then
    sed -i '/\[daemon\]/a WaylandEnable=true' "$GDM_CONF"
else
    echo -e "[daemon]\nWaylandEnable=true" >> "$GDM_CONF"
fi

echo "âœ… Wayland Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½ Ğ² $GDM_CONF"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ³Ñ€Ğ°Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ñ‹ (NVIDIA)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ğ¸Ğ´ĞµĞ¾Ğ´Ñ€Ğ°Ğ¹Ğ²ĞµÑ€Ğ°..."
gpu=$(lspci | grep -i "vga\|3d\|display" | head -1)

echo "Ğ’Ğ¸Ğ´ĞµĞ¾ĞºĞ°Ñ€Ñ‚Ğ°: $gpu"

if echo "$gpu" | grep -iq "nvidia"; then
    echo "âš ï¸  ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ° NVIDIA!"
    echo "â— ĞŸÑ€Ğ¾Ğ¿Ñ€Ğ¸ĞµÑ‚Ğ°Ñ€Ğ½Ñ‹Ğµ Ğ´Ñ€Ğ°Ğ¹Ğ²ĞµÑ€Ñ‹ NVIDIA Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ÑÑ‚ Wayland Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ."
    echo "   Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸:"
    echo "   1. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ X11 (Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸ 'GNOME on Xorg' Ğ½Ğ° ÑĞºÑ€Ğ°Ğ½Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ°)"
    echo "   2. Ğ˜Ğ»Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸ Wayland-ÑÑ€ĞµĞ´Ñƒ: Sway/Hyprland"
    echo "   3. Ğ˜Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ: export __GL_YIELD='USLEEP' Ğ² ~/.profile"
    read -p "ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ Wayland (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ nouveau/Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ğ´Ñ€Ğ°Ğ¹Ğ²ĞµÑ€Ğ¾Ğ²)? [y/N] " -n1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "â›” Wayland Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ñ‘Ğ½ Ğ¸Ğ·-Ğ·Ğ° NVIDIA."
        sed -i 's/WaylandEnable=true/WaylandEnable=false/' "$GDM_CONF"
        echo "âœ… GDM Ğ¿ĞµÑ€ĞµĞ²ĞµĞ´Ñ‘Ğ½ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ½Ğ° X11"
        exit 0
    fi
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "ğŸ”§ ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸..."

# Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ gdm3 â€” Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñ‹Ğ¹ Ğ´Ğ¸ÑĞ¿Ğ»ĞµĞ¹-Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€
if command -v dpkg-reconfigure >/dev/null; then
    echo "gdm3 gdm3/daemon select /usr/sbin/gdm3" | debconf-set-selections
    dpkg-reconfigure -f noninteractive gdm3
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
cat << 'EOF'
âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Wayland Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!

ğŸ“Œ Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ Ğ² Wayland:
1. ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ: sudo reboot
2. ĞĞ° ÑĞºÑ€Ğ°Ğ½Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ° (GDM):
   - Ğ’Ğ²ĞµĞ´Ğ¸ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
   - ĞĞ°Ğ¶Ğ¼Ğ¸ Ğ½Ğ° âš™ï¸ (ÑˆĞµÑÑ‚ĞµÑ€Ñ‘Ğ½ĞºÑƒ) Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¾Ğ¼ Ğ½Ğ¸Ğ¶Ğ½ĞµĞ¼ ÑƒĞ³Ğ»Ñƒ
   - Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸: **"GNOME"** (Ğ½Ğµ "GNOME on Xorg")

âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ:
    echo $XDG_SESSION_TYPE
    â†’ Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ: wayland

ğŸ’¡ Ğ•ÑĞ»Ğ¸ Wayland Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ:
- ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: NVIDIA, Secure Boot, Ğ¸Ğ»Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ´Ñ€Ğ°Ğ¹Ğ²ĞµÑ€
- Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ X11 Ğ¸Ğ»Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸ Sway

ğŸš€ Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ñ‡Ğ¸ÑÑ‚Ñ‹Ğ¹ Wayland-Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ (Sway/Hyprland)? ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ â€” ÑĞºĞ¸Ğ½Ñƒ ÑĞºÑ€Ğ¸Ğ¿Ñ‚!
EOF

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo "ğŸ’¡ Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½. Wayland Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ² GDM."
echo "ğŸ”¥ Ğ¢Ñ‹ Ğ½Ğ° ÑˆĞ°Ğ³ Ğ±Ğ»Ğ¸Ğ¶Ğµ Ğº ÑĞ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¼Ñƒ Linux."

exit 0